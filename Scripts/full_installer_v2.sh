#!/bin/bash

# ==============================================================================
# DOTFILES FULL INSTALLER v2.0 - YAML NATIVE
# Sistema completo unificado - Base de datos YAML √∫nica
# ==============================================================================

set -euo pipefail

# Configuraciones globales
readonly SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
readonly DOTFILES_DIR="$(dirname "$SCRIPT_DIR")"
readonly PACKAGES_YAML="$SCRIPT_DIR/packages.yaml"
readonly ADDITIONAL_DIR="$SCRIPT_DIR/Additional"
readonly LOG_DIR="$HOME/.local/share/dotfiles/logs"
readonly CONFIG_DIR="$HOME/.config/dotfiles"

# Crear directorios necesarios
mkdir -p "$LOG_DIR" "$CONFIG_DIR"

# Logging con timestamp
readonly LOG_FILE="$LOG_DIR/full_installation_$(date +%Y%m%d_%H%M%S).log"
exec 1> >(tee -a "$LOG_FILE")
exec 2> >(tee -a "$LOG_FILE" >&2)

# Contadores globales para resumen
TOTAL_INSTALLED=0
TOTAL_FAILED=0
TOTAL_SKIPPED=0

# ==============================================================================
# FUNCIONES DE UTILIDAD
# ==============================================================================

log() {
    local level="$1"
    shift
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] [$level] $*" | tee -a "$LOG_FILE"
}

info() { log "INFO" "$@"; }
success() { log "SUCCESS" "\033[32m$*\033[0m"; }
warning() { log "WARNING" "\033[33m$*\033[0m"; }
error() { log "ERROR" "\033[31m$*\033[0m"; }

show_banner() {
    cat << 'EOF'
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                                                                      ‚ïë
‚ïë                 üöÄ DOTFILES FULL INSTALLER v2.0                     ‚ïë
‚ïë                     YAML-Native ‚Ä¢ Arch Linux                         ‚ïë
‚ïë                                                                      ‚ïë
‚ïë   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚ïë
‚ïë   ‚îÇ üì¶ Packages    ‚îÇ YAML-based package management               ‚îÇ   ‚ïë
‚ïë   ‚îÇ üîß Tweaks      ‚îÇ System optimizations & configurations      ‚îÇ   ‚ïë
‚ïë   ‚îÇ üîó Symlinks    ‚îÇ Configuration file linking                 ‚îÇ   ‚ïë
‚ïë   ‚îÇ üìÑ Logs        ‚îÇ Complete installation tracking             ‚îÇ   ‚ïë
‚ïë   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚ïë
‚ïë                                                                      ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
EOF
    echo "üïê Sesi√≥n iniciada: $(date +'%Y-%m-%d %H:%M:%S')"
    echo "ÔøΩÔøΩ Directorio: $DOTFILES_DIR"
    echo "üìÑ Log: $LOG_FILE"
    echo
}

ask_yes_no() {
    local prompt="$1"
    local default="${2:-n}"
    local response

    while true; do
        # Force writing the prompt and reading the response from /dev/tty
        echo -n "$prompt [y/N]: " > /dev/tty
        read -r response < /dev/tty
        response="${response:-$default}"
        case "${response,,}" in
            y|yes|s|si) return 0 ;;
            n|no) return 1 ;;
            *) echo "Por favor, responde con y/n (yes/no)" ;;
        esac
    done
}

# Duplicamos /dev/tty en el FD 3 para todas las lecturas interactivas
exec 3<>/dev/tty

ask_select() {
    local pkg="$1" ans
    # Escribe el prompt en fd 3 (la tty), no en stdout
    printf "   ü§î ¬øQuieres instalar %s? [s/n]: " "$pkg" >&3
    # Lee la respuesta tambi√©n de fd 3
    read -r ans <&3
    case "${ans,,}" in
        s|si|y|yes) return 0 ;;
        *)           return 1 ;;
    esac
}

# ==============================================================================
# VALIDACI√ìN Y DEPENDENCIAS
# ==============================================================================

check_dependencies() {
    info "üîç Verificando dependencias del sistema..."

    # Verificar que el sistema est√© actualizado
    info "üîÑ Verificando actualizaciones del sistema..."
    sudo pacman -Syu --noconfirm || {
        error "‚ùå Error al actualizar el sistema."
        exit 1
    }
    success "‚úÖ Sistema actualizado correctamente."

    local deps=("yq" "curl" "git" "stow")
    local missing=()

    for dep in "${deps[@]}"; do
        if ! command -v "$dep" >/dev/null 2>&1; then
            missing+=("$dep")
        fi
    done

    if [[ ${#missing[@]} -gt 0 ]]; then
        warning "Dependencias faltantes: ${missing[*]}"
        info "Instalando dependencias..."
        sudo pacman -S --needed --noconfirm "${missing[@]}"

        # Verificar que se instalaron correctamente
        local still_missing=()
        for dep in "${missing[@]}"; do
            if ! command -v "$dep" >/dev/null 2>&1; then
                still_missing+=("$dep")
            fi
        done

        if [[ ${#still_missing[@]} -gt 0 ]]; then
            error "‚ùå No se pudieron instalar: ${still_missing[*]}"
            exit 1
        fi

        success "‚úÖ Dependencias instaladas correctamente: ${missing[*]}"
    fi

    # Verificar YAML (ahora que sabemos que yq est√° disponible)
    if [[ ! -f "$PACKAGES_YAML" ]]; then
        error "Archivo packages.yaml no encontrado en: $PACKAGES_YAML"
        exit 1
    fi

    if ! yq '.' "$PACKAGES_YAML" >/dev/null 2>&1; then
        error "El archivo packages.yaml no es v√°lido"
        info "Verificando sintaxis YAML..."
        yq '.' "$PACKAGES_YAML" 2>&1 | head -10 || true
        exit 1
    fi

    success "‚úÖ Todas las dependencias est√°n disponibles"
}

install_aur_helper() {
    if command -v yay >/dev/null 2>&1; then
        info "‚úÖ yay ya est√° instalado"
        return 0
    fi
    
    info "üì¶ Instalando yay (AUR helper)..."
    
    # Instalar dependencias para compilar yay
    sudo pacman -S --needed --noconfirm base-devel git
    
    # Crear directorio temporal
    local temp_dir
    temp_dir=$(mktemp -d)
    
    # Clonar e instalar yay
    git clone https://aur.archlinux.org/yay.git "$temp_dir/yay"
    cd "$temp_dir/yay"
    makepkg -si --noconfirm
    
    # Limpiar
    cd "$SCRIPT_DIR"
    rm -rf "$temp_dir"
    
    if command -v yay >/dev/null 2>&1; then
        success "‚úÖ yay instalado correctamente"
    else
        error "‚ùå Error al instalar yay"
        exit 1
    fi
}

# ==============================================================================
# INSTALACI√ìN DE PAQUETES YAML-NATIVE
# ==============================================================================

install_package() {
    local package="$1"
    local repo_hint="$2"      # Solo informativo, NO determinante
    local optional="$3"
    local category="$4"
    local install_mode="$5"

    # Verificar si ya est√° instalado
    if pacman -Qi "$(echo "$package" | tr '[:upper:]' '[:lower:]')" >/dev/null 2>&1; then
        success "   ‚úÖ $package ya est√° instalado"
        ((TOTAL_SKIPPED++))
        return 0
    fi

    # Verificar modo de instalaci√≥n para paquetes opcionales
    if [[ "$optional" == "true" ]] && [[ "$install_mode" == "required_only" ]]; then
        info "   ‚è≠Ô∏è  Omitiendo $package (paquete opcional)"
        ((TOTAL_SKIPPED++))
        return 0
    fi

    # Preguntar al usuario en modo selectivo (SOLO EN MODO INTERACTIVO)
    if [[ "$install_mode" == "selective" ]]; then
        echo -n "   ü§î ¬øQuieres instalar $package? [s/n]: " > /dev/tty
        local response
        while true; do
            read -r response < /dev/tty
            case "${response,,}" in
                s|si|y|yes)
                    break
                    ;;
                n|no)
                    info "   ‚è≠Ô∏è  Usuario omiti√≥ $package"
                    ((TOTAL_SKIPPED++))
                    return 2
                    ;;
                *)
                    echo -n "   ‚ùì Por favor, responde con s/n: " > /dev/tty
                    ;;
            esac
        done
    fi

    info "   üîÑ Instalando $package (hint: $repo_hint)..."

    local success_flag=false
    local install_method=""
    local error_log=""

    info "      üîç Intentando con pacman..."
    if sudo pacman -S --needed --noconfirm "$package" >/dev/null 2>&1; then
        success_flag=true
        install_method="pacman (repositorios oficiales)"
    else
        error_log="pacman fall√≥"

        if command -v yay >/dev/null 2>&1; then
            info "      üîç Pacman fall√≥, intentando con yay..."
            if yay -S --needed --noconfirm "$package" >/dev/null 2>&1; then
                success_flag=true
                install_method="yay (AUR)"
            else
                error_log="$error_log; yay tambi√©n fall√≥"
            fi
        else
            error_log="$error_log; yay no disponible"
        fi
    fi

    if [[ "$success_flag" == "true" ]]; then
        success "   ‚úÖ $package instalado correctamente con $install_method"
        ((TOTAL_INSTALLED++))
        return 0
    else
        error "   ‚ùå Error al instalar $package: $error_log"
        ((TOTAL_FAILED++))
        return 1
    fi
}

install_category() {
    local category_id="$1"
    local install_mode="$2"

    # Obtener emoji, descripci√≥n y conteo directamente desde YAML
    local emoji desc packages_count
    emoji=$(yq -r ".categories[] | select(.id == \"${category_id}\") | .emoji // \"üì¶\"" "$PACKAGES_YAML")
    # Verificar existencia de la categor√≠a
    if [[ -z "$emoji" ]] || [[ "$emoji" == "null" ]]; then
        error "Categor√≠a '$category_id' no encontrada en packages.yaml"
        return 1
    fi
    desc=$(yq -r ".categories[] | select(.id == \"${category_id}\") | .description // \"Sin descripci√≥n\"" "$PACKAGES_YAML")
    packages_count=$(yq -r ".categories[] | select(.id == \"${category_id}\") | .packages | length" "$PACKAGES_YAML")

    echo
    info "üéØ Instalando: $emoji $category_id"
    echo "   üìã $desc"
    echo "   üìä $packages_count paquetes en esta categor√≠a"
    echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

    # Pre-cargar nombres y descripciones desde el bloque de la categor√≠a
    local -a pkg_names pkg_descs
    mapfile -t pkg_names < <(
        printf '%s\n' "$category_info" | yq -r '.packages[].name' -
    )
    mapfile -t pkg_descs < <(
        printf '%s\n' "$category_info" | yq -r '.packages[].description // ""' -
    )

    for i in "${!pkg_names[@]}"; do
        local name desc_pkg
        name="${pkg_names[$i]}"
        desc_pkg="${pkg_descs[$i]}"

        echo
        echo "üì¶ $name ‚Äî $desc_pkg"

        if [[ "$install_mode" == "selective" ]]; then
            if ask_select "$name"; then
                install_package "$name" "" "false" "$category_id" "$install_mode"
            else
                info "   ‚è≠Ô∏è  Omitiendo $name"
                ((TOTAL_SKIPPED++))
            fi
        else
            install_package "$name" "" "false" "$category_id" "$install_mode"
        fi
    done

    info "   ‚úÖ Procesamiento de paquetes completado."
}

select_installation_mode() {
    echo "üîß Modos de instalaci√≥n disponibles:" >&2
    echo "1) Instalaci√≥n completa (todos los paquetes)" >&2
    echo "2) Instalaci√≥n por categor√≠as" >&2
    echo "3) Instalaci√≥n selectiva (paquete por paquete)" >&2
    echo "4) Solo paquetes obligatorios" >&2
    echo >&2
    
    while true; do
        read -p "Selecciona un modo [1-4]: " mode
        case "$mode" in
            1) echo "full"; return ;;
            2) echo "categories"; return ;;
            3) echo "selective"; return ;;
            4) echo "required_only"; return ;;
            *) echo "Por favor, selecciona una opci√≥n v√°lida (1-4)" >&2 ;;
        esac
    done
}

select_categories() {
    echo >&2
    info "üì¶ Categor√≠as disponibles:" >&2
    echo >&2
    
    local categories=()
    local i=1
    # Listar id, emoji y descripci√≥n en un solo flujo
    while IFS='|' read -r id emoji desc; do
        printf "%2d) %s %s\n" "$i" "$emoji" "$id" >&2
        printf "     ‚îî‚îÄ %s\n" "$desc" >&2
        echo >&2
        categories+=("$id")
        ((i++))
    done < <(yq -r '.categories[] | .id + "|" + (.emoji // "üì¶") + "|" + (.description // "Sin descripci√≥n")' "$PACKAGES_YAML")
    
    echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ" >&2
    echo "üí° Opciones: n√∫meros separados por comas (1,3,5), rangos (1-5), o 'all'" >&2
    echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ" >&2
    
    while true; do
        read -p "üéØ Selecciona categor√≠as: " selection
        
        if [[ "$selection" == "all" ]]; then
            printf '%s\n' "${categories[@]}"
            return 0
        fi
        
        local selected=()
        local valid=true
        
        IFS=',' read -ra parts <<< "$selection"
        for part in "${parts[@]}"; do
            part=$(echo "$part" | tr -d ' ')
            
            if [[ "$part" =~ ^[0-9]+$ ]]; then
                if (( part >= 1 && part <= ${#categories[@]} )); then
                    selected+=("${categories[$((part-1))]}")
                else
                    error "N√∫mero fuera de rango: $part" >&2
                    valid=false
                    break
                fi
            elif [[ "$part" =~ ^[0-9]+-[0-9]+$ ]]; then
                local start end
                start=$(echo "$part" | cut -d'-' -f1)
                end=$(echo "$part" | cut -d'-' -f2)
                
                if (( start >= 1 && end <= ${#categories[@]} && start <= end )); then
                    for ((j=start; j<=end; j++)); do
                        selected+=("${categories[$((j-1))]}")
                    done
                else
                    error "Rango inv√°lido: $part" >&2
                    valid=false
                    break
                fi
            else
                error "Formato inv√°lido: $part" >&2
                valid=false
                break
            fi
        done
        
        if [[ "$valid" == "true" ]] && [[ ${#selected[@]} -gt 0 ]]; then
            # Eliminar duplicados
            local unique_selected=()
            for item in "${selected[@]}"; do
                if [[ ! " ${unique_selected[*]} " =~ " ${item} " ]]; then
                    unique_selected+=("$item")
                fi
            done
            
            printf '%s\n' "${unique_selected[@]}"
            return 0
        else
            warning "Selecci√≥n inv√°lida. Intenta de nuevo." >&2
            echo >&2
        fi
    done
}

install_package_simple() {
    local pkg="$1"
    local install_mode="$2"
    
    # Verificar si ya est√° instalado
    if pacman -Qi "$pkg" &>/dev/null; then
        success "   ‚úÖ $pkg ya est√° instalado (omitiendo)"
        ((TOTAL_SKIPPED++))
        return 0
    fi

    # Preguntar al usuario en modo selectivo
    if [[ "$install_mode" == "selective" ]]; then
        while true; do
            read -rp "   ü§î ¬øQuieres instalar $pkg? [s/n]: " yn < /dev/tty
            case "${yn,,}" in
                s|si|y|yes) break ;;  # confirmar instalaci√≥n
                n|no)
                    info "   ‚è≠Ô∏è  Usuario omiti√≥ $pkg"
                    ((TOTAL_SKIPPED++))
                    return 0    # no abortar al omitir
                    ;;
                *)
                    echo -n "   ‚ùì Por favor, responde con s/n: " > /dev/tty
                    ;;
            esac
        done
    fi

    info "   üîÑ Instalando $pkg..."

    local success_flag=false
    local install_method=""
    local error_log=""

    # Intentar con pacman primero
    if sudo pacman -S --needed --noconfirm "$pkg" &>/dev/null; then
        success_flag=true
        install_method="pacman (repositorios oficiales)"
    else
        error_log="pacman fall√≥"

        # Intentar con yay si est√° disponible
        if command -v yay >/dev/null 2>&1; then
            if yay -S --needed --noconfirm "$pkg" &>/dev/null; then
                success_flag=true
                install_method="yay (AUR)"
            else
                error_log="$error_log; yay tambi√©n fall√≥"
            fi
        else
            error_log="$error_log; yay no disponible"
        fi
    fi

    if [[ "$success_flag" == "true" ]]; then
        success "   ‚úÖ $pkg instalado correctamente con $install_method"
        ((TOTAL_INSTALLED++))
        return 0
    else
        error "   ‚ùå Error al instalar $pkg: $error_log"
        ((TOTAL_FAILED++))
        return 1
    fi
}

install_packages_yaml() {
    local install_mode="$1"
    info "üöÄ Iniciando instalaci√≥n de paquetes en modo: $install_mode"
    echo

    # 1) Pre-cargar todas las entradas CATEGORY|DESCRIPTION|PKG en un array
    mapfile -t pkg_entries < <(
        yq -r '.categories[] | .id as $cat | .description as $desc | .packages[].name as $pkg | "\($cat)|\($desc)|\($pkg)"' "$PACKAGES_YAML"
    )

    # 2) Iterar en el shell principal para mantener stdin intacto
    local prev_cat=""
    for entry in "${pkg_entries[@]}"; do
        IFS='|' read -r cat_id cat_desc pkg_name <<<"$entry"
        # Mostrar header solo una vez por categor√≠a
        if [[ "$cat_id" != "$prev_cat" ]]; then
            echo
            info "üéØ Categor√≠a: $cat_id"
            echo "   üìã $cat_desc"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            prev_cat="$cat_id"
        fi
        # Instalar cada paquete individualmente
        echo "üì¶ $pkg_name"
        install_package_simple "$pkg_name" "$install_mode" || true  # no abort on skip or error
    done
}

install_packages() {
    local install_mode="$1"
    shift
    local categories=("${@}")
    
    # Usar la nueva funci√≥n YAML directamente
    install_packages_yaml "$install_mode"
}

# Instalar paquetes solo de categor√≠as seleccionadas usando l√≥gica de full-mode (por categor√≠as)
install_selected_categories() {
    local install_mode="$1"
    shift
    local categories=("$@")
    info "üöÄ Iniciando instalaci√≥n por categor√≠as seleccionadas: ${categories[*]}"
    echo
    for cat in "${categories[@]}"; do
        # Obtener descripci√≥n de la categor√≠a
        local desc
        desc=$(yq -r ".categories[] | select(.id == \"${cat}\") | .description // \"Sin descripci√≥n\"" "$PACKAGES_YAML")
        # Cargar lista de paquetes
        mapfile -t pkgs < <(
            yq -r ".categories[] | select(.id == \"${cat}\") | .packages[].name" "$PACKAGES_YAML"
        )
        echo
        info "üéØ Categor√≠a: $cat"
        echo "   üìã $desc"
        echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
        for pkg in "${pkgs[@]}"; do
            echo "üì¶ $pkg"
            install_package_simple "$pkg" "$install_mode" || true
        done
    done
}

# ==============================================================================
# SCRIPTS ADICIONALES
# ==============================================================================

run_additional_scripts() {
    if [[ ! -d "$ADDITIONAL_DIR" ]]; then
        warning "Directorio Additional/ no encontrado, omitiendo..."
        return 0
    fi
    
    echo
    info "üîß Ejecutando scripts de configuraci√≥n adicional..."
    echo
    
    # Lista de scripts adicionales disponibles
    local additional_scripts=(
        "Pacman.sh:üé® Configuraci√≥n avanzada de pacman"
        "MineGRUB.sh:‚õèÔ∏è  Tema Minecraft para GRUB"
        "fastfetch.sh:üöÄ Configuraci√≥n de fastfetch"
        "setup-bluetooth.sh:üì∂ Configuraci√≥n de Bluetooth"
    )
    
    for script_info in "${additional_scripts[@]}"; do
        local script_name="${script_info%%:*}"
        local script_desc="${script_info#*:}"
        local script_path="$ADDITIONAL_DIR/$script_name"
        
        if [[ -f "$script_path" ]]; then
            echo "$script_desc"
            if ask_yes_no "¬øEjecutar $script_name?"; then
                info "Ejecutando $script_name..."
                if bash "$script_path"; then
                    success "‚úÖ $script_name completado"
                else
                    error "‚ùå Error en $script_name"
                fi
            else
                info "‚è≠Ô∏è  Omitiendo $script_name"
            fi
            echo
        fi
    done
}

run_extra_packages() {
    local extra_script="$SCRIPT_DIR/install_extra_packs.sh"
    
    if [[ -f "$extra_script" ]]; then
        echo
        info "üì¶ Script de paquetes adicionales disponible"
        if ask_yes_no "¬øEjecutar instalaci√≥n de paquetes extra?"; then
            info "Ejecutando install_extra_packs.sh..."
            if bash "$extra_script"; then
                success "‚úÖ Paquetes extra instalados"
            else
                error "‚ùå Error en paquetes extra"
            fi
        else
            info "‚è≠Ô∏è  Omitiendo paquetes extra"
        fi
    fi
}

setup_symlinks() {
    local stow_script="$SCRIPT_DIR/stow-links.sh"
    
    if [[ -f "$stow_script" ]]; then
        echo
        info "üîó Configuraci√≥n de enlaces simb√≥licos disponible"
        if ask_yes_no "¬øConfigurar enlaces simb√≥licos de dotfiles?"; then
            info "Ejecutando stow-links.sh..."
            if bash "$stow_script"; then
                success "‚úÖ Enlaces simb√≥licos configurados"
            else
                error "‚ùå Error en enlaces simb√≥licos"
            fi
        else
            info "‚è≠Ô∏è  Omitiendo enlaces simb√≥licos"
        fi
    fi
}

# ==============================================================================
# VISTA PREVIA DE PAQUETES
# ==============================================================================
show_packages_preview() {
    local categories=("${@}")
    echo
    info "üîç Vista previa de paquetes por categor√≠a:"  
    for cat in "${categories[@]}"; do
        echo
        info "üìÅ $cat"
        # Cargar nombres de paquetes en array
        mapfile -t pkgs < <(
            yq -r ".categories[] | select(.id == \"$cat\") | .packages[].name" "$PACKAGES_YAML"
        )
        echo "   Paquetes (${#pkgs[@]}):"
        for pkg in "${pkgs[@]}"; do
            echo "     - $pkg"
        done
    done
    echo
}

# ==============================================================================
# RESUMEN FINAL
# ==============================================================================

show_final_summary() {
    echo
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë                    üéâ INSTALACI√ìN COMPLETADA                        ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo
    echo "üìä Resumen de paquetes:"
    echo "   ‚úÖ Instalados exitosamente: $TOTAL_INSTALLED"
    echo "   ‚ùå Fallidos: $TOTAL_FAILED"
    echo "   ‚è≠Ô∏è  Omitidos: $TOTAL_SKIPPED"
    echo
    echo "üìÑ Log completo: $LOG_FILE"
    echo "üïê Sesi√≥n finalizada: $(date +'%Y-%m-%d %H:%M:%S')"
    echo
    
    if [[ $TOTAL_FAILED -gt 0 ]]; then
        warning "‚ö†Ô∏è  Algunos paquetes fallaron. Revisa el log para m√°s detalles."
    else
        success "üöÄ ¬°Todos los paquetes se instalaron correctamente!"
    fi
    
    echo
    info "üîÑ Recomendaciones post-instalaci√≥n:"
    echo "   ‚Ä¢ Reinicia tu sesi√≥n para aplicar cambios de shell"
    echo "   ‚Ä¢ Revisa la configuraci√≥n de Hyprland en ~/.config/hypr/"
    echo "   ‚Ä¢ Ejecuta 'fastfetch' para ver el resultado"
    echo
}

# ==============================================================================
# FUNCI√ìN PRINCIPAL
# ==============================================================================

main() {
    show_banner
    
    # === PRE-VERIFICACI√ìN: DIAGN√ìSTICO DEL SISTEMA ===
    echo
    info "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    info "              üîç PRE-VERIFICACI√ìN DEL SISTEMA                   "
    info "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    
    # Ejecutar diagn√≥stico r√°pido
    local diagnostic_script="$SCRIPT_DIR/system_diagnostic.sh"
    if [[ -f "$diagnostic_script" ]]; then
        info "üîç Ejecutando diagn√≥stico autom√°tico del sistema..."
        if bash "$diagnostic_script" auto; then
            success "‚úÖ Sistema verificado y preparado correctamente"
        else
            error "‚ùå Se encontraron problemas en el sistema"
            warning "Revisa el output anterior antes de continuar"
            if ! ask_yes_no "¬øContinuar de todas formas?"; then
                info "Instalaci√≥n cancelada por el usuario"
                exit 1
            fi
        fi
    else
        warning "Script de diagn√≥stico no encontrado, continuando sin verificaci√≥n previa"
    fi
    
    # Verificaciones iniciales (ahora mejoradas)
    check_dependencies
    install_aur_helper
    
    # === FASE 1: INSTALACI√ìN DE PAQUETES ===
    echo
    info "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    info "                    üì¶ FASE 1: PAQUETES                        "
    info "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    
    # Seleccionar modo de instalaci√≥n
    local install_mode
    install_mode=$(select_installation_mode)
    
    # Seleccionar categor√≠as seg√∫n el modo
    local categories=()
    case "$install_mode" in
        "full"|"selective"|"required_only")
            info "üîç Leyendo categor√≠as del YAML..."
            while IFS= read -r category_id; do
                if [[ -n "$category_id" ]] && [[ "$category_id" != "null" ]]; then
                    categories+=("$category_id")
                    info "  ‚úì Encontrada categor√≠a: $category_id"
                fi
            done < <(yq '.categories[].id' "$PACKAGES_YAML" 2>/dev/null)
            
            if [[ ${#categories[@]} -eq 0 ]]; then
                error "No se pudieron leer las categor√≠as del YAML"
                info "Verificando archivo YAML..."
                if [[ -f "$PACKAGES_YAML" ]]; then
                    info "üìÑ Archivo YAML existe: $PACKAGES_YAML"
                    info "üîç Primeras l√≠neas del YAML:"
                    head -10 "$PACKAGES_YAML"
                else
                    error "‚ùå Archivo YAML no encontrado: $PACKAGES_YAML"
                fi
                exit 1
            fi
            ;;
        "categories")
            while IFS= read -r category_id; do
                if [[ -n "$category_id" ]]; then
                    categories+=("$category_id")
                fi
            done < <(select_categories)
            ;;
    esac
    
    if [[ ${#categories[@]} -eq 0 ]]; then
        warning "No se seleccionaron categor√≠as para instalar"
        error "üîç Debug: Modo seleccionado: $install_mode"
        error "üìÑ YAML utilizado: $PACKAGES_YAML"
        error "üìä Verificando contenido del YAML..."
        # Verificar si yq puede leer las categor√≠as
        if yq -r '.categories[].id' "$PACKAGES_YAML" 2>/dev/null | head -5; then
            error "yq puede leer el archivo, pero algo m√°s est√° mal"
        else
            error "yq no puede leer el archivo YAML correctamente"
        fi
        
        exit 1
    else
        success "‚úÖ Se encontraron ${#categories[@]} categor√≠as: ${categories[*]}"
        echo
        
        # Mostrar mensaje diferente seg√∫n el modo de instalaci√≥n
        case "$install_mode" in
            "full")
                info "üöÄ MODO COMPLETO: Se instalar√°n TODOS los paquetes de todas las categor√≠as autom√°ticamente"
                # Contar paquetes desde YAML
                local total_packages
                total_packages=$(yq -r '[.categories[].packages | length] | add' "$PACKAGES_YAML")
                info "üìä Total estimado: $total_packages paquetes"
                if ask_yes_no "‚ö†Ô∏è  ¬øContinuar con la instalaci√≥n completa autom√°tica?"; then
                    install_packages "$install_mode" "${categories[@]}"
                else
                    info "Instalaci√≥n cancelada"
                fi
                ;;
            "selective")
                info "üéØ MODO SELECTIVO: Se mostrar√°n todos los paquetes para selecci√≥n individual"
                info "üìã Categor√≠as a procesar: ${categories[*]}"
                info "üí° Para cada paquete se preguntar√°: '¬øInstalar [paquete]? [s/n]'"
                # In selective mode, proceed directly
                install_packages "$install_mode" "${categories[@]}"
                ;;
            "required_only")
                local required_count=$(jq '[.categories[].packages[] | select(.optional == false or .optional == null)] | length' "$PACKAGES_JSON")
                local optional_count=$(jq '[.categories[].packages[] | select(.optional == true)] | length' "$PACKAGES_JSON")
                info "üì¶ MODO REQUERIDOS: Se instalar√°n solo los paquetes marcados como obligatorios"
                info "‚úÖ Paquetes obligatorios: $required_count"
                info "‚è≠Ô∏è  Paquetes opcionales (omitidos): $optional_count"
                if ask_yes_no "¬øContinuar con la instalaci√≥n de paquetes obligatorios?"; then
                    install_packages "$install_mode" "${categories[@]}"
                else
                    info "Instalaci√≥n cancelada"
                fi
                ;;
            "categories")
                info "üìÅ MODO CATEGOR√çAS: Se instalar√°n TODOS los paquetes de las categor√≠as seleccionadas"
                info "üéØ Categor√≠as seleccionadas: ${categories[*]}"
                # Mostrar vista previa de paquetes
                show_packages_preview "${categories[@]}"
                if ask_yes_no "¬øContinuar con la instalaci√≥n de las categor√≠as seleccionadas?"; then
                    install_selected_categories "$install_mode" "${categories[@]}"
                else
                    info "Instalaci√≥n cancelada"
                fi
                ;;    
        esac
    fi
    
    # === FASE 2: CONFIGURACIONES ADICIONALES ===
    echo
    info "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    info "                üîß FASE 2: CONFIGURACIONES                     "
    info "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    
    run_additional_scripts
    run_extra_packages
    
    # === FASE 3: ENLACES SIMB√ìLICOS ===
    echo
    info "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    info "                  üîó FASE 3: ENLACES SIMB√ìLICOS                "
    info "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    
    setup_symlinks
    
    # === RESUMEN FINAL ===
    show_final_summary
}

# Manejar se√±ales para limpieza
trap 'error "Instalaci√≥n interrumpida"; exit 130' INT TERM

# Ejecutar si es llamado directamente
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
